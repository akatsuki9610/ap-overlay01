<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>OVERLAY CONTROLLER (Firebase Ver.)</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .control-panel { background: #2a2a2a; padding: 15px; border-radius: 8px; border: 1px solid #444; margin-bottom: 20px; width: 800px; }
        .section-title { font-size: 12px; color: #888; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .team-selection { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .team-block { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .no-select { width: 60px; }
        .name-select { flex: 1; }
        .score-select { width: 50px; font-size: 20px; font-weight: bold; text-align: center; }
        .vs-text { font-size: 24px; font-weight: bold; color: #888; }
        .phase-controls { display: flex; gap: 30px; justify-content: center; }
        .phase-group { display: flex; flex-direction: column; gap: 8px; text-align: center; }
        .phase-btn { width: 130px; padding: 10px; cursor: pointer; border: none; border-radius: 4px; background: #444; color: #ccc; font-weight: bold; }
        .phase-btn.active-ban { background: #ff3333 !important; color: white; box-shadow: 0 0 10px #ff3333; }
        .phase-btn.active-pick { background: #ffba39 !important; color: black; box-shadow: 0 0 10px #ffba39; }
        .row { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .card { background: #333; padding: 15px; border-radius: 8px; border: 1px solid #444; width: 150px; text-align: center; }
        button { width: 100%; padding: 12px 0; margin: 5px 0; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-ban.active { background: #ff3333; color: white; }
        .btn-pick.active { background: #ff8c00; color: white; }
        .import-area { font-size: 10px; color: #666; text-align: right; }
        textarea { width: 100%; height: 60px; background: #111; color: #0f0; border: 1px solid #333; margin-top: 5px; font-family: monospace; }
        
        /* ロック画面用CSS */
        #lock-overlay { 
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center; flex-direction:column;
        }
    </style>
</head>
<body>

    <div id="lock-overlay">
        <h1 style="color:white;">他のスタッフが操作中です</h1>
        <p style="color:#ccc;">二重操作を防ぐため、この画面はロックされています。</p>
        <button onclick="window.forceUnlock()" style="width:auto; padding:10px 20px; background: #ff3333; color: white;">強制解除して操作する</button>
    </div>

    <div class="control-panel">
        <div class="section-title">MATCH INFO</div>
        <div style="display:flex; gap:15px; align-items:center; justify-content: center;">
            ラウンド: <select id="round-val" onchange="window.sync()"><option>一回戦</option><option>二回戦</option><option>準決勝</option><option>決勝</option></select>
            形式: <select id="bo-val" onchange="window.sync()"><option value="BO3">BO3</option><option value="BO5">BO5</option></select>
            現在のセット: <select id="set-val" onchange="window.sync()"><select id="set-val" onchange="window.resetSelection()"><option value="第1セット">1</option><option value="第2セット">2</option><option value="第3セット">3</option><option value="第4セット">4</option><option value="第5セット">5</option></select>
        </div>
    </div>

    <div class="control-panel">
        <div class="section-title">TEAM SELECTION & SCORE</div>
        <div class="team-selection">
            <div class="team-block">
                <div style="display:flex; gap:5px;">
                    <select id="alpha-no" class="no-select" onchange="window.onTeamNoChange('alpha')"><option value="">No.</option></select>
                    <select id="alpha-name" class="name-select" onchange="window.onTeamNameChange('alpha')"><option value="">チーム名を選択</option></select>
                </div>
            </div>
            <select id="alpha-score" class="score-select" onchange="window.sync()"><option>0</option><option>1</option><option>2</option><option>3</option></select>
            <div class="vs-text">VS</div>
            <select id="bravo-score" class="score-select" onchange="window.sync()"><option>0</option><option>1</option><option>2</option><option>3</option></select>
            <div class="team-block">
                <div style="display:flex; gap:5px;">
                    <select id="bravo-name" class="name-select" onchange="window.onTeamNameChange('bravo')"><option value="">チーム名を選択</option></select>
                    <select id="bravo-no" class="no-select" onchange="window.onTeamNoChange('bravo')"><option value="">No.</option></select>
                </div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <div class="section-title">BAN / PICK PHASE</div>
        <div class="phase-controls">
            <div class="phase-group">
                <button id="p-alpha-ban" class="phase-btn" onclick="window.setPhase('alpha', 'ban')">ALPHA BAN</button>
                <button id="p-alpha-pick" class="phase-btn" onclick="window.setPhase('alpha', 'pick')">ALPHA PICK</button>
            </div>
            <button class="phase-btn" onclick="window.setPhase('', '')" style="align-self: flex-end;">解除</button>
            <div class="phase-group">
                <button id="p-bravo-ban" class="phase-btn" onclick="window.setPhase('bravo', 'ban')">BRAVO BAN</button>
                <button id="p-bravo-pick" class="phase-btn" onclick="window.setPhase('bravo', 'pick')">BRAVO PICK</button>
            </div>
        </div>
    </div>

    <div class="row" id="controls-top"></div>
    <div class="row" id="controls-bottom"></div>

    <div class="control-panel import-area">
        <textarea id="csv-import" placeholder="スプレッドシートのデータを貼り付け" oninput="window.importTeams()"></textarea>
        <button onclick="window.resetSelection()" style="width: auto; padding: 5px 15px;">選択リセット</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnNBvjjgg24swnbnchts8imAFckbBtQbE",
            authDomain: "ap-eventtool.firebaseapp.com",
            projectId: "ap-eventtool",
            storageBucket: "ap-eventtool.firebasestorage.app",
            messagingSenderId: "1054354601976",
            appId: "1:1054354601976:web:d660ed86e2a91415acc80d",
            databaseURL: "https://ap-eventtool-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const lockRef = ref(db, 'is_locked');
        let myLock = false;

        // --- ロック機能の実装 ---
        onValue(lockRef, (snapshot) => {
            const locked = snapshot.val();
            const overlay = document.getElementById('lock-overlay');
            if (locked && !myLock) {
                overlay.style.display = 'flex';
            } else if (!locked && !myLock) {
                // ロックが空いていれば取得
                myLock = true;
                set(lockRef, true);
                onDisconnect(lockRef).set(false);
            } else {
                overlay.style.display = 'none';
            }
        });

        window.forceUnlock = function() {
            if(confirm("他の人が操作中の可能性があります。強制的に解除しますか？")) {
                myLock = false;
                set(lockRef, false);
                location.reload();
            }
        };

        // --- 以下、既存のロジック ---
        let slots = Array.from({length: 7}, () => ({ ban: false, pick: false }));
        let currentPhase = { team: '', type: '' };
        let teamMaster = [];
        const stageList = ["ユノハナ大渓谷", "海女美術大学", "クサヤ温泉", "タラポートショッピングパーク", "コンブトラック", "ネギトロ炭鉱", "リュウグウターミナル"];
        const imageFiles = ["01_ユノハナ大渓谷.png", "09_海女美術大学.png", "13_クサヤ温泉.png", "17_タラポートショッピングパーク.png", "18_コンブトラック.png", "22_ネギトロ炭鉱.png", "24_リュウグウターミナル.png"];

        window.importTeams = function() {
            const text = document.getElementById('csv-import').value;
            const lines = text.trim().split('\n');
            teamMaster = lines.map(line => {
                const cols = line.split('\t');
                return { no: cols[0], name: cols[1], kana: cols[2] || '' };
            });
            ['alpha', 'bravo'].forEach(t => {
                const noSel = document.getElementById(`${t}-no`);
                const nameSel = document.getElementById(`${t}-name`);
                noSel.innerHTML = '<option value="">No.</option>';
                nameSel.innerHTML = '<option value="">チーム名を選択</option>';
                teamMaster.forEach(team => {
                    noSel.innerHTML += `<option value="${team.no}">${team.no}</option>`;
                    nameSel.innerHTML += `<option value="${team.name}">${team.name}</option>`;
                });
            });
        };

        window.onTeamNoChange = function(team) {
            const no = document.getElementById(`${team}-no`).value;
            const match = teamMaster.find(t => t.no === no);
            if(match) { document.getElementById(`${team}-name`).value = match.name; window.sync(); }
        };

        window.onTeamNameChange = function(team) {
            const name = document.getElementById(`${team}-name`).value;
            const match = teamMaster.find(t => t.name === name);
            if(match) { document.getElementById(`${team}-no`).value = match.no; window.sync(); }
        };

        window.resetSelection = function() {
            slots = slots.map(() => ({ ban: false, pick: false }));
            currentPhase = { team: '', type: '' };
            render(); window.sync();
        };

        window.setPhase = function(team, type) { currentPhase = { team, type }; render(); window.sync(); };

        window.toggle = function(i, type) {
            if (!currentPhase.team || type !== currentPhase.type) return;
            slots[i][type] = !slots[i][type];
            if(type === 'ban' && slots[i].ban) slots[i].pick = false;
            if(type === 'pick' && slots[i].pick) slots[i].ban = false;
            render(); window.sync();
        };

        function render() {
            const rowTop = document.getElementById('controls-top'), rowBottom = document.getElementById('controls-bottom');
            rowTop.innerHTML = ''; rowBottom.innerHTML = '';
            slots.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'card';
                const banD = !currentPhase.team || currentPhase.type !== 'ban';
                const pickD = !currentPhase.team || currentPhase.type !== 'pick';
                div.innerHTML = `<h3>${stageList[i]}</h3>
                    <button class="btn-ban ${s.ban ? 'active' : ''}" style="opacity:${banD?0.3:1}" onclick="window.toggle(${i}, 'ban')">BAN</button>
                    <button class="btn-pick ${s.pick ? 'active' : ''}" style="opacity:${pickD?0.3:1}" onclick="window.toggle(${i}, 'pick')">PICK</button>`;
                if (i < 4) rowTop.appendChild(div); else rowBottom.appendChild(div);
            });
            document.querySelectorAll('.phase-btn').forEach(b => b.classList.remove('active-ban', 'active-pick'));
            if(currentPhase.team) document.getElementById(`p-${currentPhase.team}-${currentPhase.type}`).classList.add(currentPhase.type==='ban'?'active-ban':'active-pick');
        }

        window.sync = function() {
            const alphaName = document.getElementById('alpha-name').value;
            const bravoName = document.getElementById('bravo-name').value;
            const currentSet = document.getElementById('set-val').value;
            const currentPick = slots.reduce((acc, s, i) => {
                if (s.pick) acc = { name: stageList[i], img: imageFiles[i], pickedBy: currentPhase.team || 'alpha' };
                return acc;
            }, null);
            const pickHistory = {}; 
            if (currentPick) pickHistory[currentSet] = currentPick;

            const data = {
                slotsStatus: slots, activePhase: currentPhase,
                matchInfo: { round: document.getElementById('round-val').value, bo: document.getElementById('bo-val').value, set: currentSet },
                alpha: { name: alphaName || 'YELLOW TEAM', score: document.getElementById('alpha-score').value, kana: teamMaster.find(t => t.name === alphaName)?.kana || '' },
                bravo: { name: bravoName || 'BLUE TEAM', score: document.getElementById('bravo-score').value, kana: teamMaster.find(t => t.name === bravoName)?.kana || '' },
                pickHistory: pickHistory 
            };
            set(ref(db, 'match_state'), data);
        };

        render();
    </script>
</body>
</html>

