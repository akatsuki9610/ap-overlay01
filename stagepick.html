<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <style>
        /* CSS部分は以前のものをそのまま維持しています */
        body { 
            margin: 0; width: 1920px; height: 1080px; background: none;
            font-family: "Arial Black", "Avenir Next", "Segoe UI", "Meiryo", sans-serif;
            color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 60px;
        }
        #match-header {
            display: flex; align-items: center;
            background: linear-gradient(135deg, rgba(61, 62, 176, 0.9), rgba(40, 41, 120, 0.95));
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 5px 15px; border-radius: 20px; min-width: 950px; height: 80px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); margin-bottom: 120px; position: relative;
        }
        .team-block { flex: 1; display: flex; align-items: center; height: 100%; padding: 0 40px; color: #ffffff; font-weight: 900; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .team-block.left { justify-content: flex-start; border-bottom: 6px solid #FFD541; border-radius: 0 0 0 15px; }
        .team-block.right { justify-content: flex-end; text-align: right; border-bottom: 6px solid #007cd4; border-radius: 0 0 15px 0; }
        .team-display-name { white-space: nowrap; line-height: 1; }
        .score-center {
            background: linear-gradient(180deg, #4d4ebf, #2d2e8f); color: #ffffff;
            min-width: 220px; height: 96px; margin: -8px 20px 0 20px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 52px; font-weight: 900;
            box-shadow: 0 12px 25px rgba(0,0,0,0.6); z-index: 10; border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .score-separator { margin: 0 20px; letter-spacing: 0; }
        #history-container { display: flex; gap: 25px; justify-content: center; align-items: center; }
        .history-item { position: relative; width: 280px; height: 500px; border: 3px solid rgba(255, 255, 255, 0.2); background: #000; overflow: hidden; border-radius: 20px; transition: all 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .history-item.filled.alpha-pick { border: 6px solid #FFD541; box-shadow: 0 0 30px rgba(255, 213, 65, 0.4); }
        .history-item.filled.bravo-pick { border: 6px solid #005DA1; box-shadow: 0 0 30px rgba(0, 93, 161, 0.4); }
        .ink-container { position: absolute; top: 0; right: 0; width: 130px; height: 130px; z-index: 10; display: flex; justify-content: center; align-items: center; }
        .ink-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        .ink-text { position: relative; z-index: 11; font-size: 20px; font-weight: 900; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); transform: rotate(15deg); margin-top: -8px; margin-left: 8px; }
        .stage-img { width: 100%; height: 100%; object-fit: cover; }
        .placeholder-container { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; }
        .bg-unknown { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.5; }
        .logo-mark { position: relative; width: 75%; height: auto; opacity: 0.8; z-index: 2; }
        .info-overlay { position: absolute; bottom: 0; width: 100%; height: 35%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(transparent, rgba(0,0,0,0.9)); z-index: 3; }
        .set-num { font-size: 20px; color: #ffba39; font-weight: bold; margin-bottom: 6px; }
        .stage-name { font-size: 24px; text-align: center; line-height: 1.3; padding: 0 15px; text-shadow: 2px 2px 4px #000; }
    </style>
</head>
<body>
    <div id="match-header">
        <div class="team-block left"><span id="alpha-name-display" class="team-display-name">---</span></div>
        <div class="score-center">
            <span id="alpha-score-display">0</span><span class="score-separator">-</span><span id="bravo-score-display">0</span>
        </div>
        <div class="team-block right"><span id="bravo-name-display" class="team-display-name">---</span></div>
    </div>
    <div id="history-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnNBvjjgg24swnbnchts8imAFckbBtQbE",
            authDomain: "ap-eventtool.firebaseapp.com",
            projectId: "ap-eventtool",
            storageBucket: "ap-eventtool.firebasestorage.app",
            messagingSenderId: "1054354601976",
            appId: "1:1054354601976:web:d660ed86e2a91415acc80d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        function getTeamFontSize(name) {
            const len = name ? name.length : 0;
            if (len <= 8) return "36px";
            if (len <= 12) return "28px";
            if (len <= 16) return "22px";
            return "18px";
        }

        // Firebaseからデータを受け取って描画
        const matchRef = ref(db, 'match_state');
        onValue(matchRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // ヘッダー更新
            const alphaEl = document.getElementById('alpha-name-display');
            alphaEl.textContent = data.alphaName || "TEAM A";
            alphaEl.style.fontSize = getTeamFontSize(data.alphaName);
            document.getElementById('alpha-score-display').textContent = data.alphaScore || 0;

            const bravoEl = document.getElementById('bravo-name-display');
            bravoEl.textContent = data.bravoName || "TEAM B";
            bravoEl.style.fontSize = getTeamFontSize(data.bravoName);
            document.getElementById('bravo-score-display').textContent = data.bravoScore || 0;

            renderHistory(data.bo, data.pickHistory || {});
        });

        function renderHistory(boType, pickHistory) {
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            const count = (boType === "BO5") ? 5 : 3;

            for (let i = 1; i <= count; i++) {
                const setKey = `第${i}セット`;
                const item = pickHistory[setKey];
                const div = document.createElement('div');
                let pickClass = '';
                if (item) {
                    pickClass = (item.pickedBy === 'alpha') ? 'alpha-pick' : 'bravo-pick';
                }
                div.className = `history-item ${item ? 'filled' : ''} ${pickClass}`;

                let inkHTML = '';
                if (i === 1) {
                    inkHTML = `<div class="ink-container"><img src="ink_ptn01.png" class="ink-img"><div class="ink-text">RANDOM</div></div>`;
                } else if (item) {
                    const inkImg = (item.pickedBy === 'alpha') ? 'ink_ptn02.png' : 'ink_ptn03.png';
                    inkHTML = `<div class="ink-container"><img src="${inkImg}" class="ink-img"><div class="ink-text">PICKED</div></div>`;
                }

                div.innerHTML = item ? `
                    ${inkHTML}<img src="${item.img}" class="stage-img">
                    <div class="info-overlay"><div class="set-num">${setKey}</div><div class="stage-name">${item.name}</div></div>
                ` : `
                    ${inkHTML}<div class="placeholder-container"><img src="unknown.png" class="bg-unknown"><img src="WFC_logo.png" class="logo-mark"></div>
                    <div class="info-overlay"><div class="set-num" style="opacity: 0.6;">${setKey}</div></div>
                `;
                container.appendChild(div);
            }
        }
    </script>
</body>
</html>